<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Pesquisas de Preços de Combustíveis em Joinville/SC</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-table@1.24.0/dist/bootstrap-table.min.css">
    <script src="/libs/tools.js"></script>

  </head>

  <body>
    <h1 class="text-center">Lista de Preços</h1>
    <p class="text-center">Clique no ID do posto para ver o histórico, ou no endereço para abrir no Maps.</p>
    <table class="table-responsive table container text-center" data-toggle="table" data-pagination="true" data-search="true" id="tabela-precos">
      <thead>
        <tr>
          <th data-sortable="true" data-sorter="numericSorter">ID do Posto</th>
          <th>Nome do Posto</th>
          <th>Endereço</th>
          <th data-sortable="true" id="coluna-preco-gasolina-comum">Gasolina <br>comum</th>
          <th data-sortable="true" id="coluna-preco-gasolina-aditivada">Gasolina <br>aditivada</th>
          <th data-sortable="true" id="coluna-preco-gasolina-premium">Gasolina <br>premium</th>
          <th data-sortable="true" id="coluna-preco-etanol">Etanol</th>
          <th data-sortable="true" id="coluna-preco-diesel">Diesel</th>
          <th data-sortable="true" id="coluna-preco-gnv">GNV</th>
        </tr>
      </thead>
      <tbody>
        {% for posto in dados_ultima_pesquisa %}
        <tr>
          <td> <a href="/historico/{{ posto.id }}">{{ posto.id }}</a> </td>
          <td> {{ posto.nome }} </td>
          <td> <a href="http://www.google.com/maps?q={{ posto.endereco | replace(".", "") }} - {{ posto.bairro }} -Joinville"> {{ posto.endereco }} - {{ posto.bairro }} </a></td>
          <td> {{ ('%.2f' % posto.gasolina_comum if posto.gasolina_comum else '---') | replace(".", ",") }} </td>
          <td> {{ ('%.2f' % posto.gasolina_aditivada if posto.gasolina_aditivada else '---') | replace (".", ",") }} </td>
          <td> {{ ('%.2f' % posto.gasolina_premium if posto.gasolina_premium else '---') | replace (".", ",") }} </td>
          <td> {{ ('%.2f' % posto.etanol if posto.etanol else '---') | replace (".", ",") }} </td>
          <td> {{ ('%.2f' % posto.diesel if posto.diesel else '---') | replace (".", ",") }} </td>
          <td> {{ ('%.2f' % posto.GNV if posto.GNV else '---') | replace (".", ",") }} </td>
        </tr>
        {% endfor %}
    </tbody>
    </table>
    <footer class="text-center mt-5">
      © 2025- <a href="mailto:renan.birck.pinheiro@gmail.com">Renan Birck Pinheiro</a> - <a href="https://github.com/renanbirck/gasolina">GitHub</a>
    <p> Pesquisa mais atual: {{ ultima_pesquisa.data }} (ID {{ultima_pesquisa.id}})</p>
    </footer>


    <script src="https://cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-table@1.24.0/dist/bootstrap-table.min.js"></script>
    <script src="/libs/bootstrap-table-pt-BR.js"></script>

    <script>
        // Para permitir ordenação numérica (muito me surpreende que o bootstrap-table não tenha isso por padrão).

        function numericSorter(a, b) {
            // Remove currency symbols, commas, etc. and convert to number
            let aValue = parseFloat(a.replace(/[^\d.-]/g, ''));
            let bValue = parseFloat(b.replace(/[^\d.-]/g, ''));

            // Handle NaN values
            if (isNaN(aValue)) aValue = 0;
            if (isNaN(bValue)) bValue = 0;

            return aValue - bValue;
        }

        function destacarPrecos() {
          const tabela = document.getElementById('tabela-precos');
          const linhasTabela = Array.from(tabela.tBodies[0].rows);
          const colunasPrecos = [3,4,5,6,7,8];

          // Limpar formatações anteriores
          $('#tabela-precos td').removeClass('bg-success bg-danger text-white');

          // Para cada coluna de preço, encontrar o menor e maior valor GLOBAL
          colunasPrecos.forEach(idColuna => {
            // Buscar todos os valores da coluna em TODAS as linhas (mesmo as não visíveis)
            let valores = [];
            $('#tabela-precos tbody tr').each(function(i, row) {
              const cell = row.cells[idColuna];
              if (!cell) return;
              const conteudoCelula = cell.textContent.trim().replace(',', '.');
              const value = parseFloat(conteudoCelula);
              if (!isNaN(value)) {
                valores.push({ value, cell });
              }
            });

            if (valores.length === 0) return;

            // Encontrar menor e maior valor
            const minValor = Math.min(...valores.map(v => v.value));
            const maxValor = Math.max(...valores.map(v => v.value));

            // Destacar todas as células com o menor e maior valor
            valores.forEach(v => {
              if (v.value === minValor) v.cell.classList.add('bg-success', 'text-white');
              if (v.value === maxValor) v.cell.classList.add('bg-danger', 'text-white');
            });
          });
        }

        // Run after table is rendered
        $(function() {
          $('#tabela-precos').on('post-body.bs.table', destacarPrecos);
          destacarPrecos();
        });

    </script>
  </body>
</html>
